{{- $image := partial "helper/image" (dict "Resources" .Page.Resources "Image" .Destination) -}}
{{- $alt := .PlainText | safeHTML -}}
{{- $title := .Title | markdownify -}}

{{/* SVG and external images won't work with gallery layout, because their width and height attributes are unknown */}}
{{- $galleryImage := and $image (and (reflect.IsMap $image) $image.Height $image.Width) -}}

{{ if and $image (reflect.IsMap $image) }}
<img src="{{ $image.Permalink }}"
	{{ with $image.Width }}width="{{ . }}"{{ end }}
	{{ with $image.Height }}height="{{ . }}"{{ end }}
	loading="lazy"
	{{ with $alt }}
		alt="{{ . }}"
	{{ end }}
    {{ with $title }}
        title="{{ . }}"
        data-title-escaped="{{ . | htmlEscape }}"
    {{ end }}
	{{ if $galleryImage }}
		class="gallery-image" 
		data-flex-grow="{{ div (mul $image.Width 100) $image.Height }}"
		data-flex-basis="{{ div (mul $image.Width 240) $image.Height }}px"
	{{ end }}
>
{{ else }}
{{/* Fallback: just render a simple img tag */}}
<img src="{{ .Destination }}"
	loading="lazy"
	{{ with $alt }}
		alt="{{ . }}"
	{{ end }}
    {{ with $title }}
        title="{{ . }}"
    {{ end }}
>
{{ end }}
